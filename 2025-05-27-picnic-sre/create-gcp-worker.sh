#!/bin/bash

gcloud compute instances create gcp-worker-01 --project=ikwilnaardekapper --zone=europe-central2-c --machine-type=e2-medium --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default --metadata=^,@^enable-osconfig=TRUE,@startup-script=\#\!/bin/bash$'\n'$'\n'TS_TOKEN=tskey-auth-k6HbhApshw11CNTRL-fu8XxqoAZwYCcREimb4VoYSuu9iqrqFa$'\n'K3S_TOKEN=K1049f10afccda03fd229859282720537748f5d0455e0ace13c87db9c36483d3116::server:6856c8278dce1a1da521c95b75655c85$'\n'$'\n'\#\ Sometimes\ apt\ hangs\ on\ boot,\ this\ should\ retry\ until\ it\ works$'\n'while\ \!\ command\ -v\ tailscale\ 2\>\&1\ \>/dev/null\;\ do$'\n'\ \ curl\ -fsSL\ https://tailscale.com/install.sh\ \|\ sh$'\n'\ \ sleep\ 0.5$'\n'done$'\n'$'\n'curl\ -sfL\ https://get.k3s.io\ \|\ INSTALL_K3S_EXEC=\"agent\"\ K3S_URL=https://control.goat-gecko.ts.net:6443\ \\$'\n'\ \ K3S_TOKEN=\"\$\{K3S_TOKEN\}\"\ sh\ -s\ -\ \\$'\n'\ \ --vpn-auth=\"name=tailscale,joinKey=\$\{TS_TOKEN\},extraArgs=--ssh\"$'\n',@ssh-keys=erwin:ecdsa-sha2-nistp256\ AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPC6kiktokX34ut3LIaAv5JChy36m/nDgFt\+o6Kv1ZFAvFMF06oUXTowf3pgFWTGWAg2K25kEN1w9IynG\+B7vK4=\ google-ssh\ \{\"userName\":\"erwin@gnur.nl\",\"expireOn\":\"2025-05-27T09:04:25\+0000\"\}$'\n'erwin:ssh-rsa\ AAAAB3NzaC1yc2EAAAADAQABAAABAGKAC4HVdYTlUNicUSNOFGr7Oi2d4dAqAZwGnkCofY/mrQ55bAdIgqqfEv/lXDPd\+3kWeld9EBCSqzoCU3uAHmWQKG9eCMHJjZ0RIWA36TWT1MxvWadi2S/wPvBN8knUd5oOtwZ/mhZdmxxgHIv3COYog3bf1Hp1b2oB0vEFWaxAbaA0eDkVHT/mACD50qPqZiehex4f4KB22\+0yQQl5IV60MxdlUyeWeUwdFQOMEsFCOt4pyLxoRdK4spMyKFx64CbX6lxzX0GSwfbfkE2FitU\+0ksVfrtMepg8jA8xIt\+lkTGEOIoAkmC0FA3r0eWiiqopijtL5zXdDdrD0vfi5EE=\ google-ssh\ \{\"userName\":\"erwin@gnur.nl\",\"expireOn\":\"2025-05-27T09:04:31\+0000\"\} --no-restart-on-failure --maintenance-policy=TERMINATE --provisioning-model=SPOT --instance-termination-action=STOP --service-account=477643265176-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/trace.append --create-disk=auto-delete=yes,boot=yes,device-name=gcp-worker-01,disk-resource-policy=projects/ikwilnaardekapper/regions/europe-central2/resourcePolicies/default-schedule-1,image=projects/debian-cloud/global/images/debian-12-bookworm-v20250513,mode=rw,size=10,type=pd-balanced --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --labels=goog-ops-agent-policy=v2-x86-template-1-4-0,goog-ec-src=vm_add-gcloud --reservation-affinity=none && printf 'agentsRule:\n  packageState: installed\n  version: latest\ninstanceFilter:\n  inclusionLabels:\n  - labels:\n      goog-ops-agent-policy: v2-x86-template-1-4-0\n' > config.yaml && gcloud compute instances ops-agents policies create goog-ops-agent-v2-x86-template-1-4-0-europe-central2-c --project=ikwilnaardekapper --zone=europe-central2-c --file=config.yaml